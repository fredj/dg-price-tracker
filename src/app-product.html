<script src="https://d3js.org/d3.v4.min.js"></script>

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="app-graph.html">

<dom-module id="app-product">
  <template>
    <style>
      paper-card {
        width: 100%;
      }
      .product-header {
        display: flex;
        align-items: center;
        padding: 8px;
      }
      .product-image {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 50px;
      }
      .title {
        flex: 1;
        font-weight: bold;
      }
      #trending {
        --iron-icon-height: 18px;
        --iron-icon-width: 18px;
      }
      iron-image.image {
        width: 40px;
        height: 40px;
      }
      .price, .title {
        padding: 0 8px;
      }
      .actions {
        border-top: 1px solid #e8e8e8;
      }
    </style>
    <paper-card>
      <div class="product-header">
        <iron-image class="image" sizing="contain" src="[[image]]"></iron-image>
        <paper-icon-button id="collapse_icon" icon="expand-more" on-tap="toggle_graph"></paper-icon-button>
        <div class="title">[[productTitle]]</div>
        <div class="price">[[as_money(price)]]</div>
        <iron-icon id="trending" icon="[[trending_icon(prices)]]"></iron-icon>
        <paper-tooltip for="trending" position="left">[[trending_as_money(prices)]] last week</paper-tooltip>
      </div>
      <iron-collapse id="collapse_panel">
        <app-graph values="[[prices]]" width="600" height="260"></app-graph>
        <div class="actions">
          <a href="[[product_url(productId)]]" target="_blank" tabindex="-1">
            <paper-icon-button src="img/[[site(productId)]].svg"></paper-icon-button>
          </a>
        </div>
      </iron-collapse>
    </paper-card>
  </template>
  <script>
    class AppProduct extends Polymer.Element {
      static get is() {
        return 'app-product';
      }
      static get properties() {
        return {
          productId: String,
          productTitle: String,
          price: Number,
          image: String,
          prices: Array
        };
      }
      static get observers() {
        return [
          'get_prices(productId)'
        ];
      }
      toggle_graph() {
        this.$.collapse_panel.toggle();
        this.$.collapse_icon.icon = this.$.collapse_panel.opened ? 'expand-less' : 'expand-more';
      }
      get_prices(productId) {
        const parseDate = d3.timeParse('%Y-%m-%d');
        d3.csv(`prices/${this.productId}.csv`, (prices) => {
          prices.forEach((price) => {
            price.date = parseDate(price.date);
            price.price = parseFloat(price.price);
          });
          this.prices = prices;
        });
      }
      site(productId) {
        return productId[0] === 'd' ? 'digitec' : 'galaxus';
      }
      trending_as_money(prices, days, digits) {
        // can't do "[[as_money(trending(prices))]]" in template
        return this.as_money(this.trending(prices, days), digits);
      }
      trending_icon(prices, days) {
        const diff = this.trending(prices, days);
        if (diff === 0) {
          return 'trending-flat';
        } else {
          return diff < 0 ? 'trending-down' : 'trending-up';
        }
      }
      trending(prices, days=7) {
        let diff = 0;
        prices.slice(-days).map((price) => price.price).forEach((price, index, arr) => {
          if (index < arr.length - 1) {
            diff += price - arr[index + 1];
          }
        });
        return -diff;
      }
      product_url(productId) {
        const id = productId.substr(2);
        return `https://www.${this.site(productId)}.ch/en/s2/product/${id}`
      }
      as_money(amount, digits=2) {
        return `${parseFloat(amount).toFixed(digits)} CHF`;
      }
    }
    customElements.define(AppProduct.is, AppProduct);
  </script>
</dom-module>
