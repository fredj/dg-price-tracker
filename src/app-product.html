<script src="https://d3js.org/d3.v4.min.js"></script>

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="app-product">
  <template>
    <style>
      :host {
        display: inline-block;
      }
      paper-card {
        width: 100%;
      }
      .product-header {
        display: flex;
        align-items: center;
        padding: 8px;
      }
      .product-image {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 50px;
      }
      .title {
        flex: 1;
        font-weight: bold;
      }
      iron-icon.trending {
        --iron-icon-height: 18px;
        --iron-icon-width: 18px;
      }
      .price {
        padding: 0 8px;
      }
      .product-image img {
        max-height: 100%;
      }


      .axis {
        font-family: monospace;
      }
      .axis .domain, .axis .tick line {
        stroke: #f3f5f7;
      }
      .axis .tick text {
        fill: #9da0ae;
      }
      path.line {
        stroke: rgba(70, 130, 180, 1.0);
        stroke-width: 1;
        fill: none;
      }
      path.area {
        fill: rgba(70, 130, 180, 0.5);
        stroke: none;
      }
    </style>
    <paper-card>
      <div class="product-header">
        <a href="[[product_url(productId)]]" target="_blank" tabindex="-1">
          <paper-icon-button src="img/[[site(productId)]].svg"></paper-icon-button>
        </a>
        <paper-icon-button id="collapse_icon" icon="expand-more" on-tap="toggle_graph"></paper-icon-button>
        <div class="title">[[productTitle]]</div>
        <div class="price">[[price]] CHF</div>
        <iron-icon class="trending" icon="[[trending_icon(prices, 7)]]"></iron-icon>
      </div>
      <iron-collapse id="collapse_panel">
        <div id="graph"></div>
      </iron-collapse>

      <!-- <div class="product-image"> -->
      <!--   <img src="[[image]]"> -->
      <!-- </div> -->
    </paper-card>
  </template>
  <script>
    class AppProduct extends Polymer.Element {
      static get is() {
        return 'app-product';
      }
      static get properties() {
        return {
          productId: String,
          productTitle: String,
          price: Number,
          image: String,
          prices: Array
        };
      }
      static get observers() {
        return [
          'get_prices(productId)'
        ];
      }
      toggle_graph() {
        this.$.collapse_panel.toggle();
        this.$.collapse_icon.icon = this.$.collapse_panel.opened ? 'expand-less' : 'expand-more';
      }
      ready() {
        super.ready();
////////////////
        const margin = {top: 20, right: 20, bottom: 30, left: 50};
        const width = 350 - margin.left - margin.right;
        const height = 200 - margin.top - margin.bottom;

        const x = d3.scaleTime().range([0, width]);
        const y = d3.scaleLinear().range([height, 0]);

        const xaxis = d3.axisBottom(x).ticks(d3.timeDay);
        const yaxis = d3.axisLeft(y);

        const svg = d3.select(this.$.graph).append('svg')
              .attr('width', width + margin.left + margin.right)
              .attr('height', height + margin.top + margin.bottom)
              .append('g')
              .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        const line = d3.line()
              .curve(d3.curveStepAfter)
              .x((d) => x(d.date))
              .y((d) => y(d.price));

        const area = d3.area()
              .curve(d3.curveStepAfter)
              .x((d) => x(d.date))
              .y0(height)
              .y1((d) => y(d.price));

        const parseDate = d3.timeParse('%Y-%m-%d');

        d3.csv(`prices/${this.productId}.csv`, (prices) => {
          prices.forEach((price) => {
            price.date = parseDate(price.date);
            price.price = parseFloat(price.price);
          });

          x.domain([
            d3.min(prices, price => price.date),
            d3.max(prices, price => price.date)
          ]);
          y.domain([0, d3.max(prices, price => price.price)])
            .nice();

          // x axis
          svg.append('g')
            .attr('class', 'axis')
            .attr('transform', 'translate(0,' + height + ')')
            .call(xaxis);

          // y axis
          svg.append('g')
            .attr('class', 'axis')
            .call(yaxis);

          // area
          svg.append('path')
            .attr('class', 'area')
            .attr('d', area(prices));

          // line
          svg.append('path')
            .attr('class', 'line')
            .attr('d', line(prices));
        });
////////////////
      }
      get_prices(productId) {
        const parseDate = d3.timeParse('%Y-%m-%d');
        d3.csv(`prices/${this.productId}.csv`, (prices) => {
          prices.forEach((price) => {
            price.date = parseDate(price.date);
            price.price = parseFloat(price.price);
          });
          this.prices = prices;
        });
      }
      site(productId) {
        return productId[0] === 'd' ? 'digitec' : 'galaxus';
      }
      trending_icon(prices, days) {
        const diff = this.trending(prices, days);
        if (diff === 0) {
          return 'trending-flat';
        } else {
          return diff < 0 ? 'trending-up' : 'trending-down';
        }
      }
      trending(prices, days) {
        let diff = 0;
        prices.slice(-days).map((price) => price.price).forEach((price, index, arr) => {
          if (index < arr.length - 1) {
            diff += price - arr[index + 1];
          }
        });
        return diff;
      }
      product_url(productId) {
        const id = productId.substr(2);
        return `https://www.${this.site(productId)}.ch/en/s2/product/${id}`
      }
    }
    customElements.define(AppProduct.is, AppProduct);
  </script>
</dom-module>
