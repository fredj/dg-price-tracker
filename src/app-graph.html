<script src="https://d3js.org/d3.v4.min.js"></script>

<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="app-graph">
  <template>
    <style>
      .axis {
        font-family: monospace;
      }
      .axis .domain, .axis .tick line {
        stroke: var(--google-grey-700);
      }
      .axis .tick text {
        fill: var(--google-grey-700);
      }
      path.line {
        stroke: rgba(70, 130, 180, 1.0);
        stroke-width: 2;
        fill: none;
      }
      path.area {
        fill: rgba(70, 130, 180, 0.3);
        stroke: none;
      }
      path, line {
        shape-rendering: crispEdges;
      }
    </style>
    <div id="graph"></div>
  </template>
  <script>
    class AppGraph extends Polymer.Element {
      static get is() {
        return 'app-graph';
      }
      static get properties() {
        return {
          width: Number,
          height: Number,
          transitionDuration: {
            type: Number,
            value: 200
          },
          period: {
            type: Number,
            observer: 'plot'
          },
          values: {
            type: Array,
            observer: 'plot'
          }
        };
      }
      ready() {
        super.ready();

        const margin = {top: 20, right: 20, bottom: 30, left: 50};
        const width = this.width - margin.left - margin.right;
        const height = this.height - margin.top - margin.bottom;

        this.x = d3.scaleTime().range([0, width]);
        this.y = d3.scaleLinear().range([height, 0]);

        this.xaxis = d3.axisBottom(this.x).ticks(d3.timeDay);
        this.yaxis = d3.axisLeft(this.y);

        this.svg = d3.select(this.$.graph).append('svg')
          .attr('width', width + margin.left + margin.right)
          .attr('height', height + margin.top + margin.bottom)
          .append('g')
          .attr('transform', `translate(${margin.left}, ${margin.top})`);

        this.line = d3.line()
          .curve(d3.curveStepAfter)
          .x((d) => this.x(d.date))
          .y((d) => this.y(d.price));

        this.area = d3.area()
          .curve(d3.curveStepAfter)
          .x((d) => this.x(d.date))
          .y0(height)
          .y1((d) => this.y(d.price));

        // x axis
        this.svg.append('g')
          .attr('class', 'axis x-axis')
          .attr('transform', `translate(0, ${height})`);

        // y axis
        this.svg.append('g')
          .attr('class', 'axis y-axis')

        // area
        this.svg.append('path')
          .attr('class', 'area');

        // line
        this.svg.append('path')
          .attr('class', 'line');

      }
      plot() {
        const period = this.period === undefined ? this.values.length : this.period;
        const values = this.values.slice(-this.period);
        this.x.domain([
          d3.min(values, price => price.date),
          d3.max(values, price => price.date)
        ]);
        this.y.domain([0, d3.max(values, price => price.price)])
          .nice();

        var svg = this.svg.transition();

        // x axis
        svg.select('.x-axis')
          .duration(this.transitionDuration)
          .call(this.xaxis);

        // y axis
        svg.select('.y-axis')
          .duration(this.transitionDuration)
          .call(this.yaxis);

        // // area
        // svg.select('.area')
        //   .duration(this.transitionDuration)
        //   .attr('d', this.area(values));

        // line
        svg.select('.line')
          .duration(this.transitionDuration)
          .attr('d', this.line(values));
      }
    };
    customElements.define(AppGraph.is, AppGraph);
  </script>
</dom-module>
