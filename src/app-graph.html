<script src="https://d3js.org/d3.v4.min.js"></script>

<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="app-graph">
  <template>
    <style>
      :host {
        display: block;
      }
      .axis {
        font-family: monospace;
      }
      .axis .domain, .axis .tick line {
        stroke: var(--google-grey-700);
      }
      .axis .tick text {
        fill: var(--google-grey-700);
      }
      path.line {
        stroke: rgba(70, 130, 180, 1.0);
        stroke-width: 2;
        fill: none;
      }
      path.area {
        fill: rgba(70, 130, 180, 0.3);
        stroke: none;
      }
      path, line {
        shape-rendering: crispEdges;
      }
    </style>
    <svg id="graph">
      <g class="container" transform="">
        <g class="axis x-axis" transform="" ></g>
        <g class="axis y-axis"></g>
        <path class="area"></path>
        <path class="line"></path>
      </g>
    </svg>
  </template>
  <script>
    class AppGraph extends Polymer.Element {
      static get is() {
        return 'app-graph';
      }
      static get properties() {
        return {
          values: Array,
          period: {
            type: Number,
            observer: 'plot'
          }
        };
      }
      constructor() {
        super();

        this.line = d3.line()
          .curve(d3.curveStepAfter)
          .x((d) => this.x(d.date))
          .y((d) => this.y(d.price));
      }
      // values or period changed
      plot() {

        /////////////////////////////////
        const period = this.period === undefined ? this.values.length : this.period;
        const values = this.values.slice(-this.period);
        this.x.domain([
          d3.min(values, price => price.date),
          d3.max(values, price => price.date)
        ]);
        this.y.domain([0, d3.max(values, price => price.price)])
          .nice();

        const graph = d3.select(this.$.graph).transition();

        // // x axis
        graph.select('.x-axis')
          .call(this.xaxis);

        // y axis
        graph.select('.y-axis')
          .call(this.yaxis);

        // line
        graph.select('.line')
          .attr('d', this.line(values));
      }
      resize() {
        const margin = {top: 20, right: 20, bottom: 30, left: 50};
        const rect = this.getBoundingClientRect();
        const width = rect.width - margin.left - margin.right;
        const height = rect.height - margin.top - margin.bottom;

        const graph = d3.select(this.$.graph)
          .attr('width', rect.width)
          .attr('height', rect.height);

        graph.select('.container')
          .attr('transform', `translate(${margin.left}, ${margin.top})`);

        graph.select('.x-axis')
          .attr('transform', `translate(0, ${height})`);

        this.x = d3.scaleTime().range([0, width]);
        this.y = d3.scaleLinear().range([height, 0]);

        this.xaxis = d3.axisBottom(this.x).ticks(d3.timeDay);
        this.yaxis = d3.axisLeft(this.y);

        this.plot();
      }
    };
    customElements.define(AppGraph.is, AppGraph);
  </script>
</dom-module>
